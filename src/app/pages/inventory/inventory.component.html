<!-- ***** src/app/pages/inventory/inventory.component.html ***** -->

<!-- contenedor general -->
<div class="container-fluid p-3 bg-light rounded-3 shadow-sm">

    <div class="row align-items-end g-3" style="display: flex; justify-content: space-between; align-items: center;">

        <!-- Input búsqueda -->
        <div class="col-md-8">
            <label for="searchInput" class="form-label">Buscar productos</label>
            <div class="input-group">
                <span class="input-text" id="search-icon">
                    <i class="bi bi-search"></i>
                </span>
                <input
                    type="text"
                    id="searchInput"
                    class="form-control"
                    placeholder="Introduce tu busqueda..."
                    aria-label="Introduce tu busqueda"
                    aria-describedby="search-icon"
                    (input)="filterByAllFields($event)" />
            </div>
        </div>

        <!-- Filtro por categoría -->
        <div class="col-md-4">
            <label for="categoryFilter" class="form-label">Filtrar por categoría</label>
            <select
                id="categoryFilter"
                class="form-select"
                (change)="filterByCategory($event)">
                <option value="">Todas las categorías...</option>
                <option *ngFor="let category of productCategories" [value]="category">
                    {{ category }}
                </option>
            </select>
        </div>
    </div>
    
    <!-- Botón agregar producto -->
    <div class="mt-3 mb-1">
        <button class="btn btn-primary" (click)="openAddProductModal()">
            + Agregar producto
        </button>
    </div>
    
    <!-- Modal para agregar nuevo producto -->
    <div
        class="modal fade"
        id="addProductModal"
        tabindex="-1"
        aria-labelledby="addProductModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addProductModalLabel">Agregar nuevo producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <app-form-addproduct (productRegistered)="onProductRegistered($event)"></app-form-addproduct>
                </div>
            </div>
        </div>
    </div>
    
</div>

    <!-- Scroll superior sincronizado -->
    <div
        id="scroll-top"
        class="mb-1"
        style="overflow-x: auto; position: relative; height: 20px;"
        onscroll="document.getElementById('scroll-wrapper').scrollLeft = this.scrollLeft">

        <!-- Contenedor real con ancho sincornizado de la tabla -->
        <div style="width: fit-content; height: 0; overflow: hidden;">
            <table class="table w-auto m-0 p-0 border-0" style="visibility: hidden;">
                <thead>
                    <tr>
                        <th style="min-width: 100px;"></th>
                        <th style="min-width: 100px;"></th>
                        <th style="min-width: 100px;"></th>
                        <th style="min-width: 100px;"></th>
                        <th style="min-width: 100px;"></th>
                        <th style="min-width: 100px;"></th>
                        <th style="min-width: 100px;"></th>
                        <th style="min-width: 100px;"></th>
                        <th style="min-width: 100px;"></th>
                        <th style="min-width: 100px;"></th>
                        <th style="min-width: 100px;"></th>
                        <th style="min-width: 100px;"></th>
                        <th style="min-width: 100px;"></th>
                        <th style="min-width: 100px;"></th>
                        <th style="min-width: 100px;"></th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>

    <!-- Tabla dentro de contenedor scroll principal -->
    <div
        id="scroll-wrapper"
        style="max-height: 400px; overflow-x: auto; overflow-y: auto;"
        onscroll="document.getElementById('scroll-top').scrollLeft = this.scrollLeft; document.getElementById('scroll-bottom').scrollLeft = this.scrollLeft">
    
        <table class="table table-sm table-bordered table-hover text-nowrap align-middle w-auto">
            <thead class="table-primary sticky-top">
                <tr>
                    <th style="min-width: 100px;">ID</th>
                    <th style="min-width: 100px;">Imagen</th>
                    <th style="min-width: 100px;">Nombre</th>
                    <th style="min-width: 100px;">Marca</th>
                    <th style="min-width: 100px;">Modelo</th>
                    <th style="min-width: 100px;">Descripción</th>
                    <th style="min-width: 100px;">Categoría</th>
                    <th style="min-width: 100px;">Capacidad</th>
                    <th style="min-width: 100px;">Velocidad</th>
                    <th style="min-width: 100px;">SKU</th>
                    <th style="min-width: 100px;"><!-- Precio --></th>
                    <th style="min-width: 100px;">Cantidad</th>
                    <th style="min-width: 100px;">Disponible</th>
                    <th style="min-width: 100px;">Guardar</th>
                    <th style="min-width: 100px;">Eliminar</th>
                </tr>
            </thead>
            <tbody>

                @for (product of products; track product.idProduct ) {
                    <tr>
                        <!-- input de imagen de producto -->
                        <td>
                            <span class="text-muted">{{ product.idProduct }}</span>
                        </td>

                        <!-- ********** input nombre de producto ********** -->
                        <td>
                            <div class="d-flex justify-content-center">
                                <img [src]="product.imgProduct"
                                    class="img-thumbnail"
                                    [ngClass]="{'opacity-50': product.productName}"
                                    style="width: 40px; height: 40px; object-fit: cover;"
                                    alt="Foto del producto" />

                                <!-- ********** Input de archivo + botón editar ********** -->
                                <input
                                    type="file"
                                    accept="image/*"
                                    #fileInput
                                    class="d-none"
                                    (change)="onImageChange(product, $event)" />
                                <button
                                    class="btn btn-sm btn-outline-secondary"
                                    (click)="fileInput.click()">
                                    Editar
                                </button>
                            </div>
                        </td>

                        <!-- ********** input nombre de producto ********** -->
                        <td>
                            <input
                                type="text"
                                class="form-control form-control-sm"
                                [(ngModel)]="product.productName"
                                (change)="updateProduct(product)"
                                placeholder="Nombre del producto" />
                        </td>

                    <!-- ********** input brand ********** -->
                    <td>                    
                        <select
                            class="form-select form-select-sm"
                            [(ngModel)]="product.brand.idBrand"
                            (change)="onBrandChange(product, $event)">
                            <option *ngFor="let brand of brands" [value]="brand.idBrand">
                                {{ brand.name }}
                            </option>
                        </select>                    
                    </td>

                    <!-- ********** input model ********** -->
                    <td>                    
                        <input
                            type="text"
                            class="form-control form-control-sm"
                            [(ngModel)]="product.model"
                            (change)="updateProduct(product)"
                            placeholder="Modelo" />                    
                    </td>

                    <!-- ********** input description ********** -->
                    <td>                    
                        <input
                            type="text"
                            class="form-control form-control-sm"
                            [(ngModel)]="product.description"
                            (change)="updateProduct(product)"
                            placeholder="Descripción" />                    
                    </td>

                    <!-- ********** input category ********** -->
                    <td>                    
                        <select
                            class="form-select form-select-sm"
                            [(ngModel)]="product.category"
                            (change)="updateProduct(product)">
                            <option *ngFor="let category of productCategories" [value]="category">
                                {{ category }}
                            </option>
                        </select>                    
                    </td>

                    <!-- ********** input capacity ********** -->
                    <td>                    
                        <select
                            class="form-select form-select-sm"
                            [(ngModel)]="product.capacity"
                            (change)="updateProduct(product)">
                            <option *ngFor="let capacity of capacityCategories" [value]="capacity">
                                {{ capacity }}
                            </option>
                        </select>                    
                    </td>

                    <!-- ********** input speed ********** -->
                    <td>                    
                        <select
                            class="form-select form-select-sm"
                            [(ngModel)]="product.speed"
                            (change)="updateProduct(product)">
                            <option *ngFor="let speed of speedCategories" [value]="speed">
                                {{ speed }}
                            </option>
                        </select>                    
                    </td>

                    <!-- ********** input SKU ********** -->
                    <td>                    
                        <input
                            type="text"
                            class="form-control form-control-sm"
                            [(ngModel)]="product.sku"
                            (change)="updateProduct(product)"
                            placeholder="SKU" />                    
                    </td>

                    <!-- ********** input price ********** -->
                    <td>                    
                    <!--     <input
                            type="number"
                            class="form-control form-control-sm"
                            [(ngModel)]="product.price"
                            (blur)="updateProduct(product)"
                            step="0.01"
                            min="0"
                            placeholder="Precio" /> -->
                    </td>

                    <!-- ********** input quantity ********** -->
                    <td>                    
                        <input
                            type="number"
                            class="form-control form-control-sm"
                            [(ngModel)]="product.quantity"
                            (change)="updateStock(product.idProduct, product.quantity)"
                            placeholder="Cantidad" />                    
                    </td>

                    <!-- ********** input available ********** -->
                    <td class="text-center">
                        <input                        
                            type="checkbox"
                            class="form-check-input"
                            [(ngModel)]="product.available"
                            (change)="toggleAvailability(product)" />                    
                    </td>

                    <!-- ********** input save ********** -->
                    <td>
                        <button
                            class="btn btn-sm btn-success"
                            (click)="updateProduct(product)">
                            Guardar
                        </button>
                    </td>

                    <!-- ********** input delete ********** -->
                    <td>
                        <button
                            class="btn btn-sm btn-danger"
                            (click)="deleteProduct(product.idProduct)">
                            Eliminar
                        </button>
                    </td>
                </tr>
            }
            @if ( products.length === 0 ) {
                <tr>
                    <td colspan="15">
                        <div class="p-2 bg-info bg-opacity-25 text-primary text-center rounded">
                            No hay productos registrados
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Scroll inferior sincronizado -->
<div
    id="scroll-bottom"
    class="mt-1"
    style="overflow-x: auto;"
    onscroll="document.getElementById('scroll-wrapper').scrollLeft = this.scrollLeft">
</div>